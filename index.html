<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ãƒ„ãƒãƒ¡ã‚«ãƒƒãƒ—2025 æŠ€ãƒã‚§ãƒƒã‚¯ï¼†ç·¨æˆ</title>
<meta name="theme-color" content="#0a84ff" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ•Šï¸</text></svg>">
<style>
:root{
  --blue:#0a84ff;
  --chip:#ffffff;
  --bar:#f0f0f0;
  --hit-bg:#fff6cc;
  --hit-bd:#ffcc66;
  --toast:#323232;
}
*{box-sizing:border-box}
body{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
  font-size:15px; line-height:1.55;
  padding:12px; background:#f6faff;
  padding-top:100px;   /* ä¸Šéƒ¨ãƒãƒ¼ï¼‹æ¤œç´¢ãƒãƒ¼ */
  padding-bottom:92px; /* ä¸‹éƒ¨ãƒŸãƒ‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
}
h1{font-size:20px;margin:4px 0 6px}
button{border:none;border-radius:8px;cursor:pointer}

.total-bar{
  position:fixed;top:0;left:0;right:0;z-index:200;
  padding:6px 10px;background:rgba(240,240,240,.96);
  box-shadow:0 2px 6px rgba(0,0,0,.2); transition:background .3s ease,color .3s ease;
}
.total-box{display:flex;flex-direction:column;gap:6px}
.total-top-row{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
.total-chip{
  background:rgba(255,255,255,.9); padding:2px 8px;
  border-radius:999px; font-size:12px; border:1px solid rgba(0,0,0,.06)
}
.total-main{font-size:16px;font-weight:700}
.total-buttons{display:flex;gap:6px}
.total-buttons button{flex:1;padding:6px 8px;font-size:12px}

.mode-bar{display:flex;gap:6px;margin:8px 0 10px;flex-wrap:wrap}
.mode-btn{flex:1;min-width:90px;padding:8px 4px;font-size:13px;border-radius:8px;border:1px solid var(--blue);background:#fff;color:var(--blue)}
.mode-btn.active{background:var(--blue);color:#fff}

.search-bar{display:flex;align-items:center;gap:8px;margin:6px 0 10px}
.search-input{flex:1;padding:8px 10px;font-size:14px;border-radius:8px;border:1px solid #cfcfcf;background:#fff}
.search-hits{font-size:12px;opacity:.7;white-space:nowrap}

.section{
  margin-top:10px;border-radius:10px;overflow:hidden;border:1px solid #e5efff;background:#fff
}
.section summary{
  list-style:none; cursor:pointer; padding:10px 12px; font-weight:700; font-size:15px;
  background:#eaf3ff; border-bottom:1px solid #e5efff; user-select:none
}
.section[open] summary{background:#dff0ff}
.section-content{padding:6px 10px}

/* â˜… ç‚¹æ•°ã”ã¨ã®è¡Œé ­ãƒ©ãƒ™ãƒ«ï¼ˆè‰²ä»˜ãï¼‰ */
.section-title{
  display:inline-block;
  margin:4px 0;
  padding:3px 9px;
  border-radius:999px;
  font-size:13px;
  font-weight:700;
}
.section-title.pt-1{background:#e3f2fd;border-left:4px solid #2196f3;}
.section-title.pt-2{background:#e8f5e9;border-left:4px solid #43a047;}
.section-title.pt-3{background:#fff3e0;border-left:4px solid #fb8c00;}
.section-title.pt-4{background:#f3e5f5;border-left:4px solid #8e24aa;}
.section-title.pt-5{background:#e0f7fa;border-left:4px solid #00838f;}
.section-title.pt-6{background:#fbe9e7;border-left:4px solid #d84315;}
.section-title.pt-7{background:#ede7f6;border-left:4px solid #5e35b1;}
.section-title.pt-8{background:#e0f2f1;border-left:4px solid #00796b;}
.section-title.pt-9{background:#fff8e1;border-left:4px solid #ffb300;}
.section-title.pt-10{background:#fce4ec;border-left:4px solid #c2185b;}

/* â˜… ç‚¹æ•°ã”ã¨ã®æŠ˜ã‚ŠãŸãŸã¿ï¼ˆdetailsï¼‰ */
.pt-group{
  margin:2px 0 4px;
}
.pt-group > summary{
  list-style:none;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:6px;
}
.pt-group > summary::-webkit-details-marker{
  display:none;
}
.pt-group-arrow{
  font-size:12px;
  opacity:.6;
}

.tech-item{
  background:#fff;margin:6px 0;padding:10px;border-radius:8px;
  display:flex;justify-content:space-between;align-items:center;gap:10px;border:1px solid transparent
}
.tech-item.search-hit{background:var(--hit-bg);border-color:var(--hit-bd)}
.tech-title{font-size:16px}
.tech-pt-label{font-size:12px;color:#666}
.tech-controls{display:flex;align-items:center;gap:14px;min-width:140px;justify-content:flex-end}
.tech-controls label{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:8px;border:1px solid #ddd;background:#fafafa}
.tech-controls input[type=checkbox]{width:18px;height:18px}

.pre-box{margin-top:14px;background:#e6f4ff;padding:10px;border-radius:10px;font-size:14px}
.pre-input{width:90px;padding:6px 8px;font-size:16px;border-radius:8px;border:1px solid #cfcfcf;background:#fff}

.warning{color:#d11;font-weight:700;display:none;font-size:12px;margin:6px 0}

.mode-section{display:none}
.mode-section.active{display:block}

.order-box{margin-top:10px;background:#fff;padding:8px;border-radius:10px;border:1px solid #ddd}
.order-box-title{font-size:13px;margin:4px 4px 6px 4px}
.order-list{list-style:none;padding:0;margin:0}
.order-item{
  display:flex;align-items:center;justify-content:space-between;gap:8px;
  padding:6px;border-bottom:1px solid #eee;font-size:14px;touch-action:none
}
.order-name{flex:1}
.order-controls{display:flex;gap:6px}
.order-btn{font-size:12px;padding:6px 8px;border-radius:8px;border:1px solid #999;background:#f5f5f5}
.order-btn-del{border-color:#ff6666;background:#ffdddd;color:#a40000}
.order-btn-move{border-color:var(--blue);background:#e2f0ff;color:#004a99}
.order-item.dragging{opacity:.6}

.pre-sum{margin-top:8px;font-size:13px;font-weight:700}

.mini-nav{
  position:fixed;left:0;right:0;bottom:0;z-index:180;background:#fff;
  box-shadow:0 -1px 6px rgba(0,0,0,.15); display:flex; justify-content:space-around; padding:6px 4px
}
.mini-btn{
  flex:1;background:transparent;border:none;font-size:11px;color:#555;
  display:flex;flex-direction:column;align-items:center;gap:2px;padding:4px 0
}
.mini-btn-icon{font-size:18px}
.mini-btn.active{color:var(--blue)}

.toast{
  position:fixed;left:50%;bottom:100px;transform:translateX(-50%);
  background:var(--toast);color:#fff;padding:10px 14px;border-radius:999px;font-size:13px;
  opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:300
}
.toast.show{opacity:.95}

@media print{
  .total-bar,.mini-nav,.search-bar,.mode-bar{display:none!important}
  body{padding-top:0;padding-bottom:0}
  .order-box{page-break-inside:avoid}
}

/* ã—ãã„å€¤ãƒãƒƒãƒ— */
.pop{animation:pop .25s ease}
@keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}

/* ãƒ„ã‚¢ãƒ¼ */
.tour{
  position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:350
}
.tour-card{
  background:#fff; width:min(520px,92vw); border-radius:12px; padding:16px; box-shadow:0 8px 28px rgba(0,0,0,.25)
}
.tour-card h3{margin:0 0 8px 0}
.tour-card ul{margin:8px 0 0 18px; font-size:14px}
.tour-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.tour-actions button{padding:8px 12px;font-size:14px}
</style>
</head>
<body>

<!-- ä¸Šéƒ¨å›ºå®šã‚¹ã‚³ã‚¢ãƒãƒ¼ -->
<div class="total-bar" id="total-bar">
  <div class="total-box">
    <div class="total-top-row" id="chips">
      <div class="total-chip">æŠ€æ•°ï¼š<span id="selected-count">0</span></div>
      <div class="total-chip">äºˆé¸ï¼š<span id="pre-total">0</span></div>
      <div class="total-chip">FMDï¼š<span id="fmd-total">0</span></div>
      <div class="total-chip">åŸºç¤ï¼š<span id="base-total">0</span></div>
    </div>
    <div class="total-main">ç·åˆè¨ˆï¼š<span id="final-total">0</span></div>
    <div class="total-buttons">
      <button style="background:var(--blue);color:#fff" id="btn-reset">ãƒªã‚»ãƒƒãƒˆ</button>
      <button style="background:#555;color:#fff" id="btn-print">å°åˆ·</button>
      <button style="background:#888;color:#fff" id="btn-export">CSVå‡ºåŠ›</button>
      <label class="order-btn" style="background:#fff" for="csv-import">CSVå–è¾¼<input id="csv-import" type="file" accept=".csv" style="display:none"></label>
    </div>
  </div>
</div>

<h1>ãƒ„ãƒãƒ¡ã‚«ãƒƒãƒ—2025 æŠ€ãƒã‚§ãƒƒã‚¯ï¼†ç·¨æˆ</h1>

<!-- äºˆé¸æ¤œç´¢ -->
<div class="search-bar">
  <label for="trick-search">äºˆé¸æŠ€æ¤œç´¢ï¼š</label>
  <input id="trick-search" class="search-input" type="text" placeholder="ä¾‹ï¼šã¨ã†ã‚ã† / ã¸ã³ / whip ãªã©">
  <span class="search-hits" id="search-hits"></span>
</div>

<!-- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ -->
<div class="mode-bar">
  <button class="mode-btn active" data-mode="score">æ±ºå‹ã‚¹ã‚³ã‚¢</button>
  <button class="mode-btn" data-mode="finals">æ±ºå‹ç·¨æˆ</button>
  <button class="mode-btn" data-mode="prelims">äºˆé¸ç·¨æˆ</button>
</div>

<p class="warning" id="warn">âš  æŠ€ã¯30å€‹ã¾ã§ã—ã‹é¸ã¹ã¾ã›ã‚“</p>

<!-- æ±ºå‹ã‚¹ã‚³ã‚¢ãƒ¢ãƒ¼ãƒ‰ -->
<div id="mode-score" class="mode-section active">
  <details class="section" open>
    <summary>ç‚¹æ•°åˆ¥ãƒªã‚¹ãƒˆï¼ˆæ±ºå‹ã‚¹ã‚³ã‚¢ï¼‰</summary>
    <div class="section-content" id="tech-list"></div>
  </details>
  <div class="pre-box">
    äºˆé¸ç‚¹ï¼ˆ0ã€œ112ï¼‰ï¼š
    <input type="number" id="pre-score" class="pre-input" value="0" min="0" max="112" />
    <p class="warning" id="pre-warn">âš  äºˆé¸ã¯0ã€œ112ç‚¹ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
  </div>

  <!-- â–¼ å…¨ä½“ãƒ—ãƒªã‚»ãƒƒãƒˆ ãƒœã‚¿ãƒ³ï¼ˆæ±ºå‹ï¼‹äºˆé¸ã¾ã¨ã‚ã¦ä¿å­˜/å¾©å…ƒï¼‰ -->
  <div style="display:flex;gap:8px;margin-top:8px;">
    <button id="save-overall-preset" style="flex:1;padding:8px;border-radius:10px;background:#fbe9ff;">å…¨ä½“æ§‹æˆã‚’ä¿å­˜</button>
    <button id="load-overall-preset" style="flex:1;padding:8px;border-radius:10px;background:#e0f7ff;">å…¨ä½“æ§‹æˆã‚’å‘¼ã³å‡ºã—</button>
  </div>
</div>

<!-- æ±ºå‹ç·¨æˆ -->
<div id="mode-finals" class="mode-section">
  <p style="font-size:13px;">æ±ºå‹ã‚¹ã‚³ã‚¢ã§é¸ã‚“ã æœ€å¤§30æŠ€ã‚’èª­ã¿è¾¼ã¿ã€é †ç•ªã‚’ä¸¦ã¹æ›¿ãˆã¾ã™ï¼ˆãƒ‰ãƒ©ãƒƒã‚°å¯ãƒ»é•·æŠ¼ã—ã§å‰Šé™¤ï¼‰ã€‚</p>
  <button id="load-finals-btn" style="background:var(--blue);color:#fff;width:100%;padding:10px;border-radius:10px">æ±ºå‹æŠ€ã‚’èª­ã¿è¾¼ã‚€</button>
  <div class="order-box">
    <div class="order-box-title">æ±ºå‹ç·¨æˆï¼ˆ<span id="finals-count">0</span>æŠ€ï¼‰</div>
    <ul id="finals-list" class="order-list"></ul>
    <p style="font-size:11px;opacity:.7;margin-top:4px;">â†‘ï¼ˆä¸Šï¼‰ï¼ â†“ï¼ˆä¸‹ï¼‰ï¼ âœ•ï¼ˆé•·æŠ¼ã—å‰Šé™¤ï¼‰ï¼ ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã¹æ›¿ãˆ</p>
  </div>
  <!-- â–¼ æ±ºå‹ãƒ—ãƒªã‚»ãƒƒãƒˆ ãƒœã‚¿ãƒ³ -->
  <div style="display:flex;gap:8px;margin-top:8px;">
    <button id="save-finals-preset" style="flex:1;padding:8px;border-radius:10px;background:#f0f4ff;">æ±ºå‹æ§‹æˆã‚’ä¿å­˜</button>
    <button id="load-finals-preset" style="flex:1;padding:8px;border-radius:10px;background:#e0ffe0;">æ±ºå‹æ§‹æˆã‚’å‘¼ã³å‡ºã—</button>
  </div>
</div>

<!-- äºˆé¸ç·¨æˆ -->
<div id="mode-prelims" class="mode-section">
  <p style="font-size:13px;">äºˆé¸ã¯<strong>12æŠ€ã¾ã§</strong>ã€‚ç¬¬1R6æŠ€ãƒ»ç¬¬2R6æŠ€ã«åˆ†å‰²ã—ã€ä¸Šä¸‹ç§»å‹•ãƒ»ãƒ‰ãƒ©ãƒƒã‚°ãƒ»â‡”ç§»å‹•ãŒã§ãã¾ã™ã€‚</p>
  <div class="warning" id="prelimit-warn">âš  äºˆé¸ã§é¸ã¹ã‚‹æŠ€ã¯12å€‹ã¾ã§ã§ã™ã€‚</div>

  <details class="section" open>
    <summary>ç‚¹æ•°åˆ¥ãƒªã‚¹ãƒˆï¼ˆäºˆé¸ã«ãƒã‚§ãƒƒã‚¯ãƒ»æ¤œç´¢ã¯ã“ã“ã«ã®ã¿é©ç”¨ï¼‰</summary>
    <div class="section-content" id="pre-tech-list"></div>
  </details>

  <button id="apply-prelims-btn" style="background:var(--blue);color:#fff;width:100%;padding:10px;border-radius:10px">é¸æŠæŠ€ã‚’äºˆé¸ã¸åæ˜ </button>

  <div class="order-box">
    <div class="order-box-title">ç¬¬1ãƒ©ã‚¦ãƒ³ãƒ‰ï¼ˆ<span id="prelims1-count">0</span>æŠ€ï¼‰</div>
    <ul id="prelims1-list" class="order-list"></ul>
  </div>
  <div class="order-box">
    <div class="order-box-title">ç¬¬2ãƒ©ã‚¦ãƒ³ãƒ‰ï¼ˆ<span id="prelims2-count">0</span>æŠ€ï¼‰</div>
    <ul id="prelims2-list" class="order-list"></ul>
  </div>

  <p class="pre-sum">äºˆé¸æŠ€ åŸºç¤ç‚¹åˆè¨ˆï¼š<span id="pre-tech-total">0</span> ç‚¹</p>

  <!-- â–¼ äºˆé¸ãƒ—ãƒªã‚»ãƒƒãƒˆ ãƒœã‚¿ãƒ³ -->
  <div style="display:flex;gap:8px;margin-top:8px;">
    <button id="save-prelims-preset" style="flex:1;padding:8px;border-radius:10px;background:#f0f4ff;">äºˆé¸æ§‹æˆã‚’ä¿å­˜</button>
    <button id="load-prelims-preset" style="flex:1;padding:8px;border-radius:10px;background:#e0ffe0;">äºˆé¸æ§‹æˆã‚’å‘¼ã³å‡ºã—</button>
  </div>
</div>

<!-- ãƒŸãƒ‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div class="mini-nav">
  <button class="mini-btn active" data-mode="score"><span class="mini-btn-icon">ğŸ§®</span><span>æ±ºå‹</span></button>
  <button class="mini-btn" data-mode="finals"><span class="mini-btn-icon">ğŸ¯</span><span>ç·¨æˆ</span></button>
  <button class="mini-btn" data-mode="prelims"><span class="mini-btn-icon">ğŸ</span><span>äºˆé¸</span></button>
  <button class="mini-btn" id="btn-recalc"><span class="mini-btn-icon">âŸ³</span><span>å†è¨ˆç®—</span></button>
  <button class="mini-btn" id="btn-top"><span class="mini-btn-icon">â¬†ï¸</span><span>TOP</span></button>
  <button class="mini-btn" data-link="judge"><span class="mini-btn-icon">ğŸ“˜</span><span>æˆåŠŸåŸºæº–</span></button>
  <button class="mini-btn" data-link="official"><span class="mini-btn-icon">ğŸŒ</span><span>å…¬å¼HP</span></button>
</div>

<!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->
<div class="toast" id="toast"></div>

<!-- åˆå›ãƒ„ã‚¢ãƒ¼ -->
<div class="tour" id="tour">
  <div class="tour-card">
    <h3>ã‚ˆã†ã“ãï¼ä½¿ã„æ–¹ã®ãƒã‚¤ãƒ³ãƒˆ</h3>
    <ul>
      <li>æ±ºå‹ã‚¹ã‚³ã‚¢ã§æŠ€ã‚’é¸ã³ã¤ã¤ã€äºˆé¸ã¯æœ€å¤§12æŠ€ã«ãƒã‚§ãƒƒã‚¯ã€‚</li>
      <li>äºˆé¸æ¤œç´¢ã¯ã²ã‚‰ãŒãª/ã‚«ã‚¿ã‚«ãƒŠOKã€ãƒ’ãƒƒãƒˆã‚’é»„è‰²ãƒã‚¤ãƒ©ã‚¤ãƒˆã€‚</li>
      <li>åˆè¨ˆã¯è‡ªå‹•ä¿å­˜ã€‚æ¬¡å›é–‹ã„ã¦ã‚‚ç¶šãã‹ã‚‰å†é–‹ã§ãã¾ã™ã€‚</li>
      <li>ãƒŸãƒ‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰å°åˆ·ãƒ»å†è¨ˆç®—ãƒ»å¤–éƒ¨ãƒªãƒ³ã‚¯ã«å³ã‚¢ã‚¯ã‚»ã‚¹ã€‚</li>
      <li>å‰Šé™¤ã¯é•·æŠ¼ã—ã§èª¤æ“ä½œé˜²æ­¢ã€‚ä¸¦ã¹æ›¿ãˆã¯ãƒ‰ãƒ©ãƒƒã‚°ã‚‚å¯ã€‚</li>
    </ul>
    <div class="tour-actions">
      <button id="tour-hide">é–‰ã˜ã‚‹</button>
      <button id="tour-never" style="background:var(--blue);color:#fff">æ¬¡å›ã‹ã‚‰è¡¨ç¤ºã—ãªã„</button>
    </div>
  </div>
</div>

<script>
/* ================== æŠ€ãƒ‡ãƒ¼ã‚¿ ================== */
const tricks = {
  1:["ç´ã‹ã‘æ‰‹ä¹—ã›","ãŠæ‰‹ç‰","ã©ã˜ã‚‡ã†ã™ãã„","ãƒ¡ãƒªãƒ¼ã‚´ãƒ¼ãƒ©ãƒ³ãƒ‰","åˆè©£","æ‰‹ä¹—ã›ã‚¸ãƒ£ãƒ³ãƒ—","è„šä¸‹ã‹ã‚‰å›ã™","ç·šé¦™èŠ±ç«","ãƒ–ãƒ¼ãƒ¡ãƒ©ãƒ³ã‚­ãƒ£ãƒƒãƒ","ãƒ™ãƒ«ãƒˆ"],
  2:["ã¤ã°ã‚è¿”ã—","ã²ã°ã‚Šè¿”ã—","ãƒªãƒ•ãƒ†ã‚£ãƒ³ã‚°","ã¤ãªã‚ãŸã‚Š","ç´ã®ã›","æ—¥æœ¬ä¸€å‘¨","ãƒ„ã‚¤ã‚¹ãƒˆç‰‡é“","ãŠæ‰‹ç‰è¶³æŠœã","ã‚«ãƒ¡ãƒ¬ã‚ªãƒ³","ãƒ•ãƒƒã‚¯"],
  3:["ãƒˆãƒ³ãƒãƒ«ã¤ãªã‚ãŸã‚Š","è…°ã‹ã‘","æ‰‹ã‹ã‚‰ãƒ¡ãƒªãƒ¼ã‚´ãƒ¼ãƒ©ãƒ³ãƒ‰ï¼ˆ3å‘¨ï¼‰","ãƒ„ã‚¤ã‚¹ãƒˆå¾€å¾©","ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³ï¼ˆ3å›ï¼‰","ãŠã¡ã‚‡ã“","ã‚¿ã‚±ã‚³ãƒ—ã‚¿ãƒ¼","äºŒæ®µã‚´ãƒ","ã‚µãƒ³ã‚ºï¼ˆ1å›ï¼‰","ç‡ˆç± ","ã‚¯ãƒ­ã‚¹ã‚­ãƒ£ãƒƒãƒ"],
  4:["æŒ‡ã®ã›","å¤§è»Šè¼ª","ã‹ã–ãã‚‹ã¾","ç«œå·»","ã¸ã³ï¼ˆ3å‘¨ï¼‰","ç‰›è‹¥ä¸¸ç‰‡é“","æ¸¦æ½®ï¼ˆä¸Šä¸‹2å›ï¼‰","ãƒ¡ãƒ€ãƒ«","èˆå¦“ã‹ã‘","ã‚³ãƒ¡ã‚¿","ãƒ ãƒ1å›","èƒ´å›ã—","è„šããã—ï¼ˆ1å›ï¼‰","è„šå›ã—","ç©ºä¸­ãƒ–ãƒ©ãƒ³ã‚³"],
  5:["ç ‚æ™‚è¨ˆ","ã¯ã‚„ã¶ã•è¿”ã—","é¯‰ã®æ»ç™»ã‚Š","ä¸¡æ‰‹ã¸ã³","è¶³ã‹ã‘","ç©ºä¸­å¤§è»Šè¼ª","è¶³ä¹—ã›","ç¸¦ã¸ã³3å‘¨","ã‚·ãƒ³ã‚°ãƒ«ã‚¯ãƒ­ãƒƒã‚¯","ãƒãƒ§ãƒƒãƒ—ã‚¹ãƒ†ã‚£ãƒƒã‚¯","ãƒªã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼å‹ã‚°ãƒªãƒ¼ãƒ³ãƒˆãƒ©ã‚¤ã‚¢ãƒ³ã‚°ãƒ«","ã‚¼ãƒ­ã‚¹ã‚¿","ã‚¯ãƒ­ã‚¹ã‚­ãƒ£ãƒƒãƒãƒ•ã‚©ãƒ¼ãƒ«","ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆç¶±æ¸¡ã‚Š"],
  6:["åœ°ç„è»Š3å‘¨","ç™½åˆƒå–ã‚Š","ç‡•å°¾è¿”ã—","ã‚ªãƒ¼ãƒ—ãƒ³ã‚¦ã‚£ãƒƒãƒ—1å›","èƒŒããã—1å›","ãƒˆãƒ«ãƒãƒ¼ãƒ‰1å›","ãƒªãƒ•ãƒ†ã‚£ãƒ³ã‚°ã€œç›´å¤§è»Šè¼ª","ãƒ”ãƒ«ã‚¨ãƒƒãƒˆï¼ˆã²ã‚‚ã®ã›ã€œã²ã‚‚ã®ã›ï¼‰","ã‚¶ãƒªã‚¬ãƒ‹é‡£ã‚Š","ç‰‡ç™½åˆƒ","ç™»ã‚Šé¾ï¼ˆ5å‘¨ï¼‰"],
  7:["é–éŒ","å¤œå‰è»Š","é¦–åˆ‡ã‚Šã€œè…°åˆ‡ã‚Šã€œè„šåˆ‡ã‚Š","å¿è€…","è„šããã— in out","ã‹ã¾ã„ãŸã¡3ã‚»ãƒƒãƒˆ in ä¸¡æ‰‹ã¸ã³","ãƒ¬ãƒ¼ãƒ«","ã‚€ã¡3","ã‚¼ãƒ­ã‚¹ã‚¿ã‚¦ã‚£ãƒƒãƒ—","ãƒªãƒªãƒ¼ã‚¹ã‚¹ã‚¿ãƒ¼ãƒˆ","ã‚¹ãƒˆãƒªãƒ³ã‚°ãƒˆãƒ«ãƒãƒ¼ãƒ‰","ã‚ªãƒ­ãƒ"],
  8:["åŒæ™‚2å€‹ç©ºä¸­æ‰‹ã®ã›","ãã‚‹ã‚Šã‚“ã±ï¼ˆ3å›ï¼‰","èƒŒé¢ãƒ ãƒ","ã‹ã¾ã„ãŸã¡3ã‚»ãƒƒãƒˆã€œå¤ªé™½ç³»1å‘¨","ç¸¦ã¸ã³4å‘¨ã€œç¯ç± ","æ­¯è»Š","äºŒå›è»¢ç™½åˆƒå–ã‚Š","ç ‚æ™‚è¨ˆã€œè£ç‡ˆç± ","Vãƒ¬ãƒ¼ãƒ«ï¼ˆ2å›ï¼‰","èƒŒé¢ãƒãƒ§ãƒƒãƒ—ã‚¹ãƒ†ã‚£ãƒƒã‚¯","ä¾ã‚¦ã‚£ãƒƒãƒ—","ä¾ã‚­ãƒ£ãƒƒãƒ","ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚€ã¡3","ã¸ã³2å¾€å¾©","è„šä¸‹ã‚ªãƒ¼ãƒ—ãƒ³ã‚¦ã‚£ãƒƒãƒ—","ãƒ‹ã‚·ã‚­ãƒ˜ãƒ“","èƒŒé¢ç‡ˆç± "],
  9:["ãƒªãƒ¥ã‚¦ã‚°ã‚¦ãƒãƒ„ã‚«ã‚¤","ã‚¦ãƒ­ãƒœãƒ­ã‚¹","ã‚¹ãƒ©ãƒƒã‚¯ãƒ©ã‚¤ãƒ³","èƒŒé¢ã‚ªãƒ¼ãƒ—ãƒ³ã‚¦ã‚£ãƒƒãƒ—","èƒŒé¢ä¸¡æ‰‹ã¸ã³","ã‚µã‚¤ãƒ‰ãƒ¯ã‚¤ãƒ³ãƒ€ãƒ¼2.0","ä¸¡é¢ã¡ã‚‡ã‚“ã‹ã‘","å¤œåˆ€ç¥","ã‚¯ã‚¨ãƒ³ãƒ†ã‚£ãƒ³ãƒ»ã‚¦ã‚£ãƒƒãƒ—","æ¸¦æ½®ã€œç‡ˆç± ","4DEX","ãƒ•ãƒƒãƒˆã‚¯ãƒ©ãƒƒãƒ","ãƒ•ãƒƒãƒˆãƒˆã‚¹è›‡","ãƒ€ãƒ–ãƒ«ãƒ”ãƒ«ã‚¨ãƒƒãƒˆç™½åˆƒå–ã‚Š","ã‚¢ãƒ¼ãƒ ã‚°ãƒ©ã‚¤ãƒ³ãƒ‰ã‚¦ã‚£ãƒƒãƒ—","èƒŒé¢ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚€ã¡3"],
 10:["ãƒ€ã‚¤ãƒ¬ã‚¯ç‡ˆç± ","2å€‹ã†ãšã—ãŠ3å›","ã¦ã˜ãªãƒ¼ã«ã‚ƒã‚€ã¡","ãƒ¤ãƒˆãƒœãƒ­ã‚¹"]
};

/* ================== DOMå‚ç…§ ================== */
const totalBar = document.getElementById('total-bar');
const chipsWrap = document.getElementById('chips');
const warn = document.getElementById('warn');
const preWarn = document.getElementById('pre-warn');
const preInput = document.getElementById('pre-score');
const selectedSpan = document.getElementById('selected-count');
const fmdSpan = document.getElementById('fmd-total');
const baseSpan = document.getElementById('base-total');
const preSpan = document.getElementById('pre-total');
const finalSpan = document.getElementById('final-total');
const searchInput = document.getElementById('trick-search');
const searchHits = document.getElementById('search-hits');
const toastEl = document.getElementById('toast');

/* ================== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ================== */
const showToast = (msg, ms=1800)=>{
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'), ms);
};
const vibrate = (ms=15)=>{ if(navigator.vibrate) navigator.vibrate(ms); };
const formatScore = v => Number.isInteger(v)?v:Math.round(v*10)/10;

/* ã‹ãªæ­£è¦åŒ–ï¼ˆã²ã‚‰â†’ã‚«ã‚¿ï¼æ¿ç‚¹è¨˜å·é™¤å»ï¼‰ */
const kanaNormalize = s => (s||'').toLowerCase()
  .replace(/[ã-ã‚–]/g, ch=>String.fromCharCode(ch.charCodeAt(0)+0x60))
  .replace(/[ï¾ï¾Ÿ]/g,'');

/* ================== ãƒªã‚¹ãƒˆæ§‹ç¯‰ ================== */
const scoreListWrap = document.getElementById("tech-list");
const preTechWrap = document.getElementById("pre-tech-list");

function makeScoreItem(pt, name){
  const item = document.createElement('div');
  item.className = 'tech-item';
  item.innerHTML = `
    <div>
      <span class="tech-title">${name}</span><br>
      <span class="tech-pt-label">${pt}ç‚¹æŠ€</span>
    </div>
    <div class="tech-controls">
      <label><input type="checkbox" class="multi">1.5å€</label>
      <label><input type="checkbox" class="chk" data-pt="${pt}" data-name="${name}">ä½¿ç”¨</label>
    </div>`;
  return item;
}
function makePreItemCheck(pt, name){
  const item = document.createElement('div');
  item.className = 'tech-item';
  item.innerHTML = `
    <div>
      <span class="tech-title">${name}</span><br>
      <span class="tech-pt-label">${pt}ç‚¹æŠ€</span>
    </div>
    <div class="tech-controls">
      <label><input type="checkbox" class="pre-chk" data-pt="${pt}" data-name="${name}">äºˆé¸</label>
    </div>`;
  return item;
}

function buildLists(){
  scoreListWrap.innerHTML='';
  preTechWrap.innerHTML='';
  Object.keys(tricks).forEach(pt=>{
    /* æ±ºå‹å´ï¼šç‚¹æ•°ã”ã¨ã« details ã§æŠ˜ã‚ŠãŸãŸã¿ */
    const sec1 = document.createElement('details');
    sec1.className = 'pt-group';
    sec1.open = true;
    const sum1 = document.createElement('summary');
    const arrow1 = document.createElement('span');
    arrow1.className = 'pt-group-arrow';
    arrow1.textContent = 'â–¼';
    const title1 = document.createElement('span');
    title1.className='section-title pt-'+pt;
    title1.textContent = `${pt}ç‚¹æŠ€`;
    sum1.appendChild(arrow1);
    sum1.appendChild(title1);
    sec1.appendChild(sum1);
    tricks[pt].forEach(n=> sec1.appendChild(makeScoreItem(pt, n)));
    scoreListWrap.appendChild(sec1);

    /* äºˆé¸å´ï¼šåŒæ§˜ã«ç‚¹æ•°ã”ã¨ã«æŠ˜ã‚ŠãŸãŸã¿ */
    const sec2 = document.createElement('details');
    sec2.className = 'pt-group';
    sec2.open = true;
    const sum2 = document.createElement('summary');
    const arrow2 = document.createElement('span');
    arrow2.className = 'pt-group-arrow';
    arrow2.textContent = 'â–¼';
    const title2 = document.createElement('span');
    title2.className='section-title pt-'+pt;
    title2.textContent = `${pt}ç‚¹æŠ€`;
    sum2.appendChild(arrow2);
    sum2.appendChild(title2);
    sec2.appendChild(sum2);
    tricks[pt].forEach(n=> sec2.appendChild(makePreItemCheck(pt, n)));
    preTechWrap.appendChild(sec2);
  });
}
buildLists();

/* ================== è¨ˆç®— ================== */
function getPreScore(){
  let v=parseFloat(preInput.value);
  if(isNaN(v)) v=0;
  let c=Math.min(Math.max(0,v),112);
  if(c!==v){ preInput.value=c; preWarn.style.display="block"; }
  else preWarn.style.display="none";
  return c;
}
let lastThreshold = 0;

/* 2000ç‚¹è¶…ã§é»’ãƒãƒ¼ï¼†ãƒãƒƒãƒ—è‰²åˆ¶å¾¡ */
function updateBarColor(total){
  const chipEls = chipsWrap.querySelectorAll('.total-chip');

  if(total>=2000){
    // ãƒãƒ¼ã¯é»’
    totalBar.style.background = "black";
    // ç·åˆè¨ˆã¯ç™½
    finalSpan.style.color = "#fff";
    // ã„ã£ãŸã‚“å…¨ãƒãƒƒãƒ—ç™½
    chipEls.forEach(c => c.style.color = "#fff");

    // ä¾‹å¤–ï¼šæŠ€æ•°ï¼äºˆé¸ï¼FMDï¼åŸºç¤ ã¯é»’
    const ids = ["selected-count","pre-total","fmd-total","base-total"];
    ids.forEach(id=>{
      const chip = document.getElementById(id)?.closest(".total-chip");
      if(chip) chip.style.color = "#000";
    });
  } else {
    // é€šå¸¸è‰²
    finalSpan.style.color = "#000";
    chipEls.forEach(c => c.style.color = "#000");

    if(total>=1900) totalBar.style.background = "#d60000";      // èµ¤
    else if(total>=1800) totalBar.style.background = "#6f2dbd"; // æ¿ƒç´«
    else if(total>=1700) totalBar.style.background = "#ff7a00"; // æ¿ƒã‚ªãƒ¬ãƒ³ã‚¸
    else if(total>=1600) totalBar.style.background = "dodgerblue";
    else if(total>=1500) totalBar.style.background = "#3dbb3d"; // ç·‘
    else totalBar.style.background = "rgba(240,240,240,.96)";
  }

  // ã—ãã„å€¤æ¼”å‡º
  const thresholds=[1500,1600,1700,1800,1900,2000];
  const crossed = thresholds.find(t=> total>=t && lastThreshold < t);
  if(crossed!=null){
    finalSpan.classList.remove('pop'); void finalSpan.offsetWidth; finalSpan.classList.add('pop');
    vibrate(18);
    showToast(`${crossed}ç‚¹ãƒ©ã‚¤ãƒ³çªç ´ï¼`);
    lastThreshold = crossed;
  }
  if(total < thresholds[0]) lastThreshold = 0;
}

function calcTotal(){
  const items=document.querySelectorAll("#mode-score .tech-item");
  let sel=0,fmd=0,base=0;
  items.forEach(it=>{
    const chk=it.querySelector(".chk");
    const multi=it.querySelector(".multi");
    if(chk && chk.checked){
      sel++;
      const b=Number(chk.dataset.pt);
      let val=b*b;
      if(multi && multi.checked) val*=1.5;
      fmd+=val; base+=b;
    }
  });
  warn.style.display = sel>30 ? "block" : "none";

  const pre=getPreScore();
  const total=fmd+base+pre;

  selectedSpan.textContent=sel;
  fmdSpan.textContent=formatScore(fmd);
  baseSpan.textContent=formatScore(base);
  preSpan.textContent=formatScore(pre);
  finalSpan.textContent=formatScore(total);

  updateBarColor(total);
  saveState(); // è‡ªå‹•ä¿å­˜
}

/* ç›£è¦– */
function bindRecalc(){
  document.querySelectorAll(".chk,.multi,.pre-chk").forEach(el=>{
    el.addEventListener("change", calcTotal);
  });
}
bindRecalc();
preInput.addEventListener("input", calcTotal);

/* æ±ºå‹ãƒã‚§ãƒƒã‚¯åˆ¶é™ */
document.addEventListener('change', e=>{
  if(e.target.classList.contains('chk')){
    const c=document.querySelectorAll(".chk:checked");
    if(c.length>30 && e.target.checked){
      e.target.checked=false;
      showToast("æŠ€ã¯30å€‹ã¾ã§ã§ã™");
    }
    calcTotal();
  }
});

/* ================== äºˆé¸ æ¤œç´¢ ================== */
function applySearch(){
  const q = kanaNormalize(searchInput.value.trim());
  let hits=0;
  document.querySelectorAll("#pre-tech-list .tech-item").forEach(item=>{
    const t=item.querySelector(".tech-title")?.textContent || "";
    const norm = kanaNormalize(t);
    const isHit = q && norm.includes(q);
    item.classList.toggle("search-hit", isHit);
    if(isHit) hits++;
  });
  searchHits.textContent = q ? `ãƒ’ãƒƒãƒˆï¼š${hits}` : '';
}
searchInput.addEventListener('input', applySearch);

/* ================== æ±ºå‹ç·¨æˆ ================== */
const finalsList=document.getElementById("finals-list");
const finalsCountSpan=document.getElementById("finals-count");

function rebuildFinalsList(){ finalsCountSpan.textContent=finalsList.querySelectorAll(".order-item").length; saveState(); }

function orderLiTemplate(pt,name){
  const li=document.createElement('li');
  li.className='order-item'; li.draggable=true;
  li.innerHTML=`
    <span class="order-name">[${pt}ç‚¹] ${name}</span>
    <div class="order-controls">
      <button class="order-btn" data-act="up">â†‘</button>
      <button class="order-btn" data-act="down">â†“</button>
      <button class="order-btn order-btn-del" data-act="del">âœ•</button>
    </div>`;
  // é•·æŠ¼ã—å‰Šé™¤
  let pressT=null;
  li.querySelector('[data-act="del"]').addEventListener('touchstart',()=>{ pressT=setTimeout(()=>{ li.remove(); rebuildFinalsList(); showToast("å‰Šé™¤ã—ã¾ã—ãŸ"); },600); },{passive:true});
  li.querySelector('[data-act="del"]').addEventListener('touchend',()=>{ if(pressT){ clearTimeout(pressT); pressT=null; showToast("é•·æŠ¼ã—ã§å‰Šé™¤",800); }});
  li.querySelector('[data-act="del"]').addEventListener('mousedown',e=>{
    pressT=setTimeout(()=>{ li.remove(); rebuildFinalsList(); showToast("å‰Šé™¤ã—ã¾ã—ãŸ"); },600);
  });
  ['mouseup','mouseleave'].forEach(ev=>li.querySelector('[data-act="del"]').addEventListener(ev,()=>{ if(pressT){clearTimeout(pressT); pressT=null;} }));
  return li;
}

document.getElementById("load-finals-btn").addEventListener("click",()=>{
  finalsList.innerHTML="";
  document.querySelectorAll(".chk:checked").forEach(chk=>{
    finalsList.appendChild(orderLiTemplate(chk.dataset.pt, chk.dataset.name));
  });
  rebuildFinalsList();
});

finalsList.addEventListener("click",e=>{
  if(!e.target.classList.contains("order-btn")) return;
  const act=e.target.dataset.act; const li=e.target.closest(".order-item");
  if(act==="up" && li.previousElementSibling) li.parentNode.insertBefore(li,li.previousElementSibling);
  else if(act==="down" && li.nextElementSibling) li.parentNode.insertBefore(li.nextElementSibling,li);
  rebuildFinalsList();
});

/* DnDï¼ˆæ±ºå‹ï¼‰ */
let dragEl=null;
finalsList.addEventListener('dragstart',e=>{ dragEl=e.target; dragEl.classList.add('dragging'); });
finalsList.addEventListener('dragend',e=>{ if(dragEl){dragEl.classList.remove('dragging'); dragEl=null; rebuildFinalsList(); }});
finalsList.addEventListener('dragover',e=>{
  e.preventDefault();
  const after = [...finalsList.querySelectorAll('.order-item:not(.dragging)')].find(el=>{
    const rect=el.getBoundingClientRect();
    return e.clientY < rect.top + rect.height/2;
  });
  if(!dragEl) return;
  if(after) finalsList.insertBefore(dragEl, after); else finalsList.appendChild(dragEl);
});

/* ================== äºˆé¸ ç·¨æˆ ================== */
const preLimitWarn=document.getElementById("prelimit-warn");
const applyPreBtn=document.getElementById("apply-prelims-btn");
const list1=document.getElementById("prelims1-list");
const list2=document.getElementById("prelims2-list");
const c1=document.getElementById("prelims1-count");
const c2=document.getElementById("prelims2-count");
const preSum=document.getElementById("pre-tech-total");

document.addEventListener('change', e=>{
  if(e.target.classList.contains('pre-chk')){
    const sel=document.querySelectorAll('.pre-chk:checked');
    if(sel.length>12 && e.target.checked){
      e.target.checked=false; preLimitWarn.style.display="block";
      showToast("äºˆé¸ã¯12æŠ€ã¾ã§ã§ã™");
    }else preLimitWarn.style.display="none";
    saveState();
  }
});

function mkPreOrderItem(pt,name,round){
  const li=document.createElement('li');
  li.className='order-item'; li.draggable=true;
  const label=round===1?"2Râ–¶":"â—€1R"; const move=round===1?"to2":"to1";
  li.innerHTML=`
    <span class="order-name">[${pt}ç‚¹] ${name}</span>
    <div class="order-controls">
      <button class="order-btn" data-act="up">â†‘</button>
      <button class="order-btn" data-act="down">â†“</button>
      <button class="order-btn order-btn-move" data-act="${move}">${label}</button>
      <button class="order-btn order-btn-del" data-act="del">âœ•</button>
    </div>`;
  // é•·æŠ¼ã—å‰Šé™¤
  let t=null, delBtn=li.querySelector('[data-act="del"]');
  const doDel=()=>{ li.remove(); updatePreSummary(); showToast("å‰Šé™¤ã—ã¾ã—ãŸ"); };
  delBtn.addEventListener('touchstart',()=>{ t=setTimeout(doDel,600); },{passive:true});
  delBtn.addEventListener('touchend',()=>{ if(t){clearTimeout(t); t=null; showToast("é•·æŠ¼ã—ã§å‰Šé™¤",800);} });
  delBtn.addEventListener('mousedown',()=>{ t=setTimeout(doDel,600); });
  ['mouseup','mouseleave'].forEach(ev=>delBtn.addEventListener(ev,()=>{ if(t){clearTimeout(t); t=null;} }));
  return li;
}

applyPreBtn.addEventListener("click",()=>{
  list1.innerHTML=""; list2.innerHTML="";
  const sel=[...document.querySelectorAll(".pre-chk:checked")];
  sel.forEach((chk,i)=>{
    const pt=chk.dataset.pt, name=chk.dataset.name;
    if(i<6) list1.appendChild(mkPreOrderItem(pt,name,1));
    else list2.appendChild(mkPreOrderItem(pt,name,2));
  });
  updatePreSummary();
  showToast("äºˆé¸ã¸åæ˜ ã—ã¾ã—ãŸ");
});

function swapMove(li, to2){
  const txt=li.querySelector(".order-name").textContent;
  const m=txt.match(/^\[(\d+)ç‚¹]\s*(.+)$/); if(!m) return;
  const pt=m[1],name=m[2];
  li.remove();
  (to2?list2:list1).appendChild(mkPreOrderItem(pt,name,to2?2:1));
}

function preListHandler(e,listSelf,listOther){
  if(!e.target.classList.contains("order-btn")) return;
  const act=e.target.dataset.act; const li=e.target.closest(".order-item");
  if(act==="up" && li.previousElementSibling) li.parentNode.insertBefore(li,li.previousElementSibling);
  else if(act==="down" && li.nextElementSibling) li.parentNode.insertBefore(li.nextElementSibling,li);
  else if(act==="del") { showToast("å‰Šé™¤ã¯é•·æŠ¼ã—ã§å®Ÿè¡Œ"); return; }
  else if(act==="to2") swapMove(li, true);
  else if(act==="to1") swapMove(li, false);
  updatePreSummary();
}

/* DnDï¼ˆäºˆé¸ï¼‰ */
function bindDnd(list){
  let dragging=null;
  list.addEventListener('dragstart',e=>{ dragging=e.target; dragging.classList.add('dragging'); });
  list.addEventListener('dragend',e=>{ if(dragging){ dragging.classList.remove('dragging'); dragging=null; updatePreSummary(); }});
  list.addEventListener('dragover',e=>{
    e.preventDefault();
    const after=[...list.querySelectorAll('.order-item:not(.dragging)')].find(el=>{
      const r=el.getBoundingClientRect(); return e.clientY < r.top + r.height/2;
    });
    if(dragging){
      if(after) list.insertBefore(dragging,after); else list.appendChild(dragging);
    }
  });
}
[list1,list2].forEach(bindDnd);

list1.addEventListener("click",e=>preListHandler(e,list1,list2));
list2.addEventListener("click",e=>preListHandler(e,list2,list1));

function updatePreSummary(){
  const sumNode = nodes=>{
    let s=0; nodes.forEach(n=>{ const m=n.textContent.match(/^\[(\d+)ç‚¹]/); if(m) s+=Number(m[1]); });
    return s;
  };
  const n1=list1.querySelectorAll(".order-name");
  const n2=list2.querySelectorAll(".order-name");
  c1.textContent=n1.length; c2.textContent=n2.length;
  preSum.textContent=sumNode(n1)+sumNode(n2);
  saveState();
}

/* ================== ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ & ãƒŸãƒ‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ ================== */
const modeButtons=document.querySelectorAll(".mode-btn");
const miniButtons=document.querySelectorAll(".mini-btn");
const sections={ score:document.getElementById("mode-score"), finals:document.getElementById("mode-finals"), prelims:document.getElementById("mode-prelims") };
function setMode(mode){
  Object.keys(sections).forEach(k=> sections[k].classList.toggle("active",k===mode));
  modeButtons.forEach(b=>b.classList.toggle("active",b.dataset.mode===mode));
  miniButtons.forEach(b=>b.classList.toggle("active",b.dataset.mode===mode));
  window.scrollTo({top:80, behavior:"smooth"});
}
modeButtons.forEach(b=>b.addEventListener("click",()=>setMode(b.dataset.mode)));
miniButtons.forEach(btn=>{
  const mode=btn.dataset.mode, link=btn.dataset.link;
  if(mode) btn.addEventListener("click",()=>setMode(mode));
  if(link==="judge") btn.addEventListener("click",()=>window.open("https://drive.google.com/file/d/107A2MhR43epd7evpE5uHPbtyjd0BvZiS/view","_blank"));
  if(link==="official") btn.addEventListener("click",()=>window.open("https://spingear.jp/index.php?dispatch=pages.view&page_id=140","_blank"));
});
document.getElementById("btn-recalc").addEventListener("click",()=>{ calcTotal(); showToast("å†è¨ˆç®—ã—ã¾ã—ãŸ"); });
document.getElementById("btn-top").addEventListener("click",()=> window.scrollTo({top:0, behavior:"smooth"}));

/* ================== ãƒªã‚»ãƒƒãƒˆ / å°åˆ· ================== */
document.getElementById("btn-reset").addEventListener("click",()=>{
  document.querySelectorAll(".chk,.multi,.pre-chk").forEach(c=>c.checked=false);
  preInput.value=0; warn.style.display="none"; preWarn.style.display="none"; preLimitWarn.style.display="none";
  list1.innerHTML=""; list2.innerHTML=""; finalsList.innerHTML="";
  searchInput.value=""; applySearch();
  localStorage.removeItem("tsubame2025");
  calcTotal(); updatePreSummary(); rebuildFinalsList();
  showToast("åˆæœŸåŒ–ã—ã¾ã—ãŸ");
});

document.getElementById("btn-print").addEventListener("click",()=>{
  const finals=[...finalsList.querySelectorAll(".order-name")].map(n=>n.textContent);
  const p1=[...list1.querySelectorAll(".order-name")].map(n=>n.textContent);
  const p2=[...list2.querySelectorAll(".order-name")].map(n=>n.textContent);
  const now = new Date().toLocaleString();
  const w=window.open("","_blank"); if(!w) return;
  w.document.write(`
  <html><head><meta charset="UTF-8">
  <style>
    body{font-family:sans-serif;padding:20px}
    h1{font-size:20px;margin:0}
    .meta{font-size:12px;color:#555;margin-bottom:8px}
    h2{font-size:16px;margin-top:16px}
    ol{padding-left:20px}
    li{margin-bottom:4px;font-size:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media print {.no-print{display:none}}
  </style></head><body>
  <h1>é¸æŠæŠ€ä¸€è¦§</h1>
  <div class="meta">ä½œæˆæ—¥æ™‚ï¼š${now} ï¼ åˆè¨ˆï¼š${finalSpan.textContent}ç‚¹ ï¼ äºˆé¸ï¼š${preSpan.textContent}ç‚¹</div>
  <div class="grid">
    <div><h2>æ±ºå‹ç·¨æˆ</h2>${finals.length? "<ol>"+finals.map(t=>"<li>"+t+"</li>").join("")+"</ol>" : "æœªè¨­å®š"}</div>
    <div>
      <h2>äºˆé¸ ç¬¬1ãƒ©ã‚¦ãƒ³ãƒ‰</h2>${p1.length? "<ol>"+p1.map(t=>"<li>"+t+"</li>").join("")+"</ol>" : "æœªè¨­å®š"}
      <h2>äºˆé¸ ç¬¬2ãƒ©ã‚¦ãƒ³ãƒ‰</h2>${p2.length? "<ol>"+p2.map(t=>"<li>"+t+"</li>").join("")+"</ol>" : "æœªè¨­å®š"}
    </div>
  </div>
  </body></html>`);
  w.document.close(); w.print();
});

/* ================== CSV å…¥å‡ºåŠ› ================== */
function exportCSV(){
  const rows=[["type","name","point","mult15","round","order"]];
  // æ±ºå‹ï¼ˆé †åºï¼‰
  [...finalsList.querySelectorAll(".order-item .order-name")].forEach((n,i)=>{
    const m=n.textContent.match(/^\[(\d+)ç‚¹]\s*(.+)$/); if(!m) return;
    rows.push(["final", m[2], m[1], "", "", i+1]);
  });
  // äºˆé¸ï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰ãƒ»é †åºï¼‰
  [...list1.querySelectorAll(".order-name")].forEach((n,i)=>{
    const m=n.textContent.match(/^\[(\d+)ç‚¹]\s*(.+)$/); if(!m) return;
    rows.push(["prelim", m[2], m[1], "", 1, i+1]);
  });
  [...list2.querySelectorAll(".order-name")].forEach((n,i)=>{
    const m=n.textContent.match(/^\[(\d+)ç‚¹]\s*(.+)$/); if(!m) return;
    rows.push(["prelim", m[2], m[1], "", 2, i+1]);
  });
  // æ±ºå‹ã‚¹ã‚³ã‚¢ã®é¸æŠï¼‹1.5å€æƒ…å ±
  document.querySelectorAll(".chk").forEach(chk=>{
    if(chk.checked){
      const name=chk.dataset.name, pt=chk.dataset.pt;
      const mul=chk.closest('.tech-item').querySelector('.multi')?.checked ? 1.5 : "";
      rows.push(["score_checked", name, pt, mul, "", ""]);
    }
  });

  const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const url=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  const a=document.createElement('a'); a.href=url; a.download='tsubame2025_export.csv'; a.click();
  URL.revokeObjectURL(url);
}
document.getElementById("btn-export").addEventListener("click",exportCSV);

document.getElementById("csv-import").addEventListener("change",async(e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const text = await f.text();
  const lines = text.split(/\r?\n/).filter(Boolean);
  const header = lines.shift()?.split(',').map(s=>s.replace(/^"|"$/g,'').replace(/""/g,'"'))||[];
  const idx=(k)=>header.indexOf(k);
  // åˆæœŸåŒ–ã—ã¦ã‹ã‚‰åæ˜ 
  document.querySelectorAll(".chk,.multi,.pre-chk").forEach(c=>c.checked=false);
  list1.innerHTML=""; list2.innerHTML=""; finalsList.innerHTML="";

  for(const line of lines){
    const cols=line.match(/("([^"]|"")*"|[^,]+)/g)?.map(s=>s.replace(/^"|"$/g,'').replace(/""/g,'"'))||[];
    const type=cols[idx("type")]; const name=cols[idx("name")]; const point=cols[idx("point")];
    if(type==="final"){
      finalsList.appendChild(orderLiTemplate(point,name));
    }else if(type==="prelim"){
      const rnd = Number(cols[idx("round")])===2;
      (rnd?list2:list1).appendChild(mkPreOrderItem(point,name, rnd?2:1));
    }else if(type==="score_checked"){
      const chk=[...document.querySelectorAll(`.chk[data-name="${CSS.escape(name)}"][data-pt="${point}"]`)][0];
      if(chk){ chk.checked=true; const mul=cols[idx("mult15")]; if(mul){ chk.closest('.tech-item').querySelector('.multi').checked=true; } }
    }
  }
  calcTotal(); updatePreSummary(); rebuildFinalsList();
  showToast("CSVã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ");
});

/* ================== è‡ªå‹•ä¿å­˜ ================== */
function saveState(){
  const state={
    pre: +preInput.value,
    checks: [...document.querySelectorAll(".chk")].map(c=>({n:c.dataset.name,p:+c.dataset.pt,u:c.checked,m:c.closest('.tech-item')?.querySelector('.multi')?.checked||false})),
    prechecks: [...document.querySelectorAll(".pre-chk")].map(c=>({n:c.dataset.name,p:+c.dataset.pt,u:c.checked})),
    finals: [...finalsList.querySelectorAll(".order-name")].map(n=>n.textContent),
    p1: [...list1.querySelectorAll(".order-name")].map(n=>n.textContent),
    p2: [...list2.querySelectorAll(".order-name")].map(n=>n.textContent),
  };
  localStorage.setItem("tsubame2025", JSON.stringify(state));
}
function loadState(){
  const raw=localStorage.getItem("tsubame2025"); if(!raw) return;
  try{
    const s=JSON.parse(raw);
    preInput.value = s.pre ?? 0;
    document.querySelectorAll(".chk").forEach(c=>{
      const f=s.checks?.find(x=>x.n===c.dataset.name && x.p==c.dataset.pt);
      if(f){ c.checked=!!f.u; const mul=c.closest('.tech-item')?.querySelector('.multi'); if(mul) mul.checked=!!f.m; }
    });
    document.querySelectorAll(".pre-chk").forEach(c=>{
      const f=s.prechecks?.find(x=>x.n===c.dataset.name && x.p==c.dataset.pt);
      if(f){ c.checked=!!f.u; }
    });
    // å†æ§‹ç¯‰ï¼ˆç°¡æ˜“ï¼‰
    finalsList.innerHTML="";
    (s.finals||[]).forEach(txt=>{
      const m=txt.match(/^\[(\d+)ç‚¹]\s*(.+)$/); if(m) finalsList.appendChild(orderLiTemplate(m[1], m[2]));
    });
    list1.innerHTML=""; (s.p1||[]).forEach(txt=>{ const m=txt.match(/^\[(\d+)ç‚¹]\s*(.+)$/); if(m) list1.appendChild(mkPreOrderItem(m[1],m[2],1)); });
    list2.innerHTML=""; (s.p2||[]).forEach(txt=>{ const m=txt.match(/^\[(\d+)ç‚¹]\s*(.+)$/); if(m) list2.appendChild(mkPreOrderItem(m[1],m[2],2)); });
    rebuildFinalsList(); updatePreSummary();
  }catch{ /* ignore */ }
}
window.addEventListener("DOMContentLoaded",()=>{ calcTotal(); loadState(); });

/* ================== ãƒ—ãƒªã‚»ãƒƒãƒˆä¿å­˜ãƒ»èª­è¾¼ ================== */
const FINAL_PRESET_KEY   = "tsubame2025_final_preset";
const PRE_PRESET_KEY     = "tsubame2025_pre_preset";
const OVERALL_PRESET_KEY = "tsubame2025_overall_preset";

function serializeOrderList(list){
  return [...list.querySelectorAll('.order-name')].map(n=>{
    const m=n.textContent.match(/^\[(\d+)ç‚¹]\s*(.+)$/);
    return m ? {pt:Number(m[1]), name:m[2]} : null;
  }).filter(Boolean);
}

/* æ±ºå‹ãƒ—ãƒªã‚»ãƒƒãƒˆ */
document.getElementById("save-finals-preset").addEventListener("click",()=>{
  const data = serializeOrderList(finalsList);
  if(!data.length){
    showToast("ä¿å­˜ã™ã‚‹æ±ºå‹æ§‹æˆãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  localStorage.setItem(FINAL_PRESET_KEY, JSON.stringify(data));
  showToast("æ±ºå‹æ§‹æˆã‚’ä¿å­˜ã—ã¾ã—ãŸ");
});
document.getElementById("load-finals-preset").addEventListener("click",()=>{
  const raw = localStorage.getItem(FINAL_PRESET_KEY);
  if(!raw){
    showToast("ä¿å­˜æ¸ˆã¿ã®æ±ºå‹æ§‹æˆãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  try{
    const data = JSON.parse(raw);
    finalsList.innerHTML = "";
    data.slice(0,30).forEach(d=>{
      finalsList.appendChild(orderLiTemplate(d.pt, d.name));
    });
    rebuildFinalsList();
    showToast("æ±ºå‹æ§‹æˆã‚’åæ˜ ã—ã¾ã—ãŸ");
  }catch{
    showToast("æ±ºå‹ãƒ—ãƒªã‚»ãƒƒãƒˆã®èª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
});

/* äºˆé¸ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆç¬¬1Rãƒ»ç¬¬2Rï¼‰ */
document.getElementById("save-prelims-preset").addEventListener("click",()=>{
  const r1 = serializeOrderList(list1);
  const r2 = serializeOrderList(list2);
  if(!r1.length && !r2.length){
    showToast("ä¿å­˜ã™ã‚‹äºˆé¸æ§‹æˆãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  const preset = {r1, r2};
  localStorage.setItem(PRE_PRESET_KEY, JSON.stringify(preset));
  showToast("äºˆé¸æ§‹æˆã‚’ä¿å­˜ã—ã¾ã—ãŸ");
});

document.getElementById("load-prelims-preset").addEventListener("click",()=>{
  const raw = localStorage.getItem(PRE_PRESET_KEY);
  if(!raw){
    showToast("ä¿å­˜æ¸ˆã¿ã®äºˆé¸æ§‹æˆãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  try{
    const preset = JSON.parse(raw);
    list1.innerHTML = "";
    list2.innerHTML = "";
    (preset.r1 || []).slice(0,6).forEach(d=>{
      list1.appendChild(mkPreOrderItem(d.pt, d.name, 1));
    });
    (preset.r2 || []).slice(0,6).forEach(d=>{
      list2.appendChild(mkPreOrderItem(d.pt, d.name, 2));
    });
    updatePreSummary();
    showToast("äºˆé¸æ§‹æˆã‚’åæ˜ ã—ã¾ã—ãŸ");
  }catch{
    showToast("äºˆé¸ãƒ—ãƒªã‚»ãƒƒãƒˆã®èª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
});

/* å…¨ä½“ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆæ±ºå‹ã‚¹ã‚³ã‚¢ï¼‹æ±ºå‹ç·¨æˆï¼‹äºˆé¸ç·¨æˆï¼‹äºˆé¸ç‚¹ï¼‰ */
document.getElementById("save-overall-preset").addEventListener("click",()=>{
  // æœ€æ–°çŠ¶æ…‹ã‚’ä¿å­˜ã—ã¦ã‹ã‚‰ã€ãã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ã‚³ãƒ”ãƒ¼
  saveState();
  const raw = localStorage.getItem("tsubame2025");
  if(!raw){
    showToast("ä¿å­˜ã™ã‚‹æ§‹æˆãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  localStorage.setItem(OVERALL_PRESET_KEY, raw);
  showToast("å…¨ä½“æ§‹æˆã‚’ä¿å­˜ã—ã¾ã—ãŸ");
});

document.getElementById("load-overall-preset").addEventListener("click",()=>{
  const raw = localStorage.getItem(OVERALL_PRESET_KEY);
  if(!raw){
    showToast("ä¿å­˜æ¸ˆã¿ã®å…¨ä½“æ§‹æˆãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  try{
    // ç¾åœ¨ã®UIã‚’åˆæœŸåŒ–ã—ã¦ã‹ã‚‰ã€å…¨ä½“ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ç¾åœ¨çŠ¶æ…‹ã«ä¸Šæ›¸ã
    document.querySelectorAll(".chk,.multi,.pre-chk").forEach(c=>c.checked=false);
    list1.innerHTML=""; list2.innerHTML=""; finalsList.innerHTML="";
    localStorage.setItem("tsubame2025", raw);
    loadState();
    calcTotal();
    updatePreSummary();
    rebuildFinalsList();
    showToast("å…¨ä½“æ§‹æˆã‚’åæ˜ ã—ã¾ã—ãŸ");
  }catch{
    showToast("å…¨ä½“ãƒ—ãƒªã‚»ãƒƒãƒˆã®èª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
});

/* ================== ãƒ„ã‚¢ãƒ¼ï¼ˆåˆå›ã®ã¿ï¼‰ ================== */
const tour=document.getElementById('tour');
const tourHide=()=>tour.style.display='none';
const tourNever=()=>{ localStorage.setItem('tsubame2025_tour','1'); tourHide(); };
document.getElementById('tour-hide').addEventListener('click',tourHide);
document.getElementById('tour-never').addEventListener('click',tourNever);
if(!localStorage.getItem('tsubame2025_tour')){ setTimeout(()=>{ tour.style.display='flex'; }, 300); }

/* ================== PWA ç°¡æ˜“å¯¾å¿œï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼‰ ================== */
// manifest ã‚’å‹•çš„ç”Ÿæˆ
(function(){
  const manifest = {
    name:"ãƒ„ãƒãƒ¡ã‚«ãƒƒãƒ—2025 æŠ€ãƒã‚§ãƒƒã‚¯ï¼†ç·¨æˆ",
    short_name:"Tsubame2025",
    start_url:"./",
    display:"standalone",
    background_color:"#f6faff",
    theme_color:"#0a84ff"
  };
  const blob = new Blob([JSON.stringify(manifest)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('link');
  link.rel="manifest"; link.href=url; document.head.appendChild(link);
})();

// Service Workerï¼ˆã“ã®ãƒšãƒ¼ã‚¸ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
if('serviceWorker' in navigator){
  const swCode = `
  const CACHE='tsubame2025-v1';
  self.addEventListener('install',e=>{
    e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])));
    self.skipWaiting();
  });
  self.addEventListener('activate',e=>{
    e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));
    self.clients.claim();
  });
  self.addEventListener('fetch',e=>{
    const url=new URL(e.request.url);
    if(url.origin===location.origin){
      e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{
        const clone=res.clone(); caches.open(CACHE).then(c=>c.put(e.request,clone)); return res;
      }).catch(()=>caches.match('./'))));
    }
  });`;
  const blob = new Blob([swCode], {type:'text/javascript'});
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl);
}
</script>
</body>
</html>
